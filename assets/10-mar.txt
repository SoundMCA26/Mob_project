-- 1. Populate the TEST table with applicant data
INSERT INTO TEST(APPNO, NAME) 
SELECT APPNO, NAME FROM APPLICANT;

-- 2. Populate the INTERVIEW table with applicant data
INSERT INTO INTERVIEW(APPNO, NAME) 
SELECT APPNO, NAME FROM APPLICANT;

-- 3. Populate the RANDOM table with applicant data
INSERT INTO RANDOM(APPNO, NAME) 
SELECT APPNO, NAME FROM APPLICANT;

-- 4. Update TEST marks for each applicant
UPDATE TEST SET TEST = DBMS_RANDOM.VALUE(30, 100);

-- 5. Update INTERVIEW marks for each applicant
UPDATE INTERVIEW SET INTERVIEW = DBMS_RANDOM.VALUE(30, 100);

-- 6. Populate the TEST attribute in APPLICANT table
DECLARE
    CURSOR C IS SELECT APPNO, TEST FROM TEST;
BEGIN
    FOR I IN C LOOP
        UPDATE APPLICANT SET TEST = I.TEST WHERE APPNO = I.APPNO;
    END LOOP;
    COMMIT;
END;
/

-- 7. Populate the INTERVIEW attribute in APPLICANT table
DECLARE
    CURSOR C IS SELECT APPNO, INTERVIEW FROM INTERVIEW;
BEGIN
    FOR I IN C LOOP
        UPDATE APPLICANT SET INTERVIEW = I.INTERVIEW WHERE APPNO = I.APPNO;
    END LOOP;
    COMMIT;
END;
/

-- 8. Populate the RANDOM NUMBER (RND) attribute
UPDATE RANDOM SET RND = ROUND(DBMS_RANDOM.VALUE(1000000000, 9999999999));
COMMIT;

DECLARE
    CURSOR C IS SELECT APPNO, RND FROM RANDOM;
BEGIN
    FOR I IN C LOOP
        UPDATE APPLICANT SET RND = I.RND WHERE APPNO = I.APPNO;
    END LOOP;
    COMMIT;
END;
/

-- 9. Update AGGR (50% of Test Marks + 50% of Interview Marks)
UPDATE APPLICANT 
SET AGGR = 0.5 * TEST + 0.5 * INTERVIEW;
COMMIT;

-- 10. Generate Rank based on AGGR and tie-breaking criteria
DECLARE
    RANK_NUM NUMBER := 0;
BEGIN
    UPDATE APPLICANT 
    SET RANK = NULL;

    FOR R IN (SELECT APPNO FROM APPLICANT ORDER BY AGGR DESC, TEST DESC, INTERVIEW DESC, DOB ASC, RND ASC)
    LOOP
        RANK_NUM := RANK_NUM + 1;
        UPDATE APPLICANT SET RANK = RANK_NUM WHERE APPNO = R.APPNO;
    END LOOP;
    COMMIT;
END;
/

-- 11. Generate Special Reservation Rank (SPLRANK) for those with SPLRES = 1
DECLARE
    SPLRANK_NUM NUMBER := 0;
BEGIN
    UPDATE APPLICANT 
    SET SPLRANK = NULL 
    WHERE SPLRES = 2;

    FOR R IN (SELECT APPNO FROM APPLICANT WHERE SPLRES = 1 ORDER BY AGGR DESC, TEST DESC, INTERVIEW DESC, DOB ASC, RND ASC)
    LOOP
        SPLRANK_NUM := SPLRANK_NUM + 1;
        UPDATE APPLICANT SET SPLRANK = SPLRANK_NUM WHERE APPNO = R.APPNO;
    END LOOP;
    COMMIT;
END;
/

-- Verify the final results
SELECT * FROM APPLICANT ORDER BY RANK;
