CREATE USER TIFFY IDENTIFIED BY TIFFY;
GRANT DBA TO TIFFY;

CREATE USER RUNNY IDENTIFIED BY RUNNY;
GRANT DBA TO RUNNY;

CREATE USER KITTY IDENTIFIED BY KITTY;
GRANT DBA TO KITTY;

CREATE TABLE STUDENT
(
HSCNO NUMBER(5) PRIMARY KEY,
NAME VARCHAR(30,
DOB DATE,
GENDER CHAR CHECK(GENDER IN('M', 'F')),
AGGR NUMBER(3)
);

INSERT INTO STUDENT VALUES(12345, 'PETER', '13-NOV-2005', 'M', 200);
INSERT INTO STUDENT VALUES(12344, 'JAMES', '12-OCT-2005', 'M', 200);
INSERT INTO STUDENT VALUES(12355, 'JOHN', '13-JAN-2006', 'M', 200);
INSERT INTO STUDENT VALUES(12356, 'MARY', '12-MAR-2006', 'M', 200);

CREATE TABLE COLLEGE
(
COLL_CODE NUMBER(3) PRIMARY KEY,
NAME VARCHAR(50)
);

INSERT INTO COLLEGE VALUES(1,'CEG');
INSERT INTO COLLEGE VALUES(2,'ACTECH');
INSERT INTO COLLEGE VALUES(3,'SAP');
INSERT INTO COLLEGE VALUES(4,'MIT');


CREATE TABLE BRANCH\(
BCODE VARCHAR(3) PRIMARY KEY,
BNAME VARCHAR(50)
);

INSERT INTO BRANCH VALUES('CSE', 'COMPUTER SCIENCE AND ENGINEERING');
INSERT INTO BRANCH VALUES('IT', 'INFORMATION TECHNOLOGY');
INSERT INTO BRANCH VALUES('CH', 'CHEMICAL ENGINEERING');
INSERT INTO BRANCH VALUES('AR', 'ARCHITECTURE');

CREATE TABLE COLL_BRANCH
(
COLL_CODE REFERENCES COLLEGE,
BCODE REFERENCES BRANCH,
NOS NUMBER(3),
PRIMARY KEY(COLL_CODE, BCODE)
);

INSERT INTO COLL_BRANCH VALUES(1, 'CSE', 120);
INSERT INTO COLL_BRANCH VALUES(1, 'IT', 120);
INSERT INTO COLL_BRANCH VALUES(4, 'CSE', 120);
INSERT INTO COLL_BRANCH VALUES(4, 'IT', 120);
INSERT INTO COLL_BRANCH VALUES(3, 'AR', 20);
INSERT INTO COLL_BRANCH VALUES(2, 'CH', 30);

CREATE TABLE ALLOTMENT
(
ROLLNO REFERENCES STUDENT PRIMARY KEY,
COLL_CODE NUMBER(3),
BCODE VARCHAR(5),
FOREIGN KEY(COLL_CODE, BCODE) REFERENCES COLL_BRANCH
);


DESC USER_DB_LINKS
DESC ALL_DB_LINKS
DESC DBA_DB_LINKS

@SITE TIFFY
CREATE DATABASE LINK TIFFYTORUNNY CONNECT TO RUNNY IDENTIFIED BY RUNNY USING 'ORCL';
SELECT * FROM STUDENT;
SELECT * FROM BRANCH;
SELECT * FROM COLL_BRANCH;
SELECT * FROM ALLOTMENT;
SHOW USER

CREATE DATABASE LINK TIFFYTOKITTY CONNECT TO KITTY IDENTIFIED BY KITTY USING 'ORCL';
SELECT * FROM STUDENT;
SELECT * FROM BRANCH;
SELECT * FROM COLL_BRANCH;
SELECT * FROM ALLOTMENT;
SHOW USER

@SITE RUNNY
CREATE DATABASE LINK KITTYTOTIFFY CONNECT TO TIFFY IDENTIFIED BY TIFFY USING 'ORCL';
SELECT * FROM STUDENT;
SELECT * FROM BRANCH;
SELECT * FROM COLL_BRANCH;
SELECT * FROM ALLOTMENT;
SHOW USER

@SITE KITTY
CREATE DATABASE LINK RUNNYTOTIFFY CONNECT TO TIFFY IDENTIFIED BY TIFFY USING 'ORCL';
SELECT * FROM STUDENT;
SELECT * FROM BRANCH;
SELECT * FROM COLL_BRANCH;
SELECT * FROM ALLOTMENT;
SHOW USER

@SITE RUNNY
CREATE OR REPLACE TRIGGER AVAILABILITY 
AFTER INSERT ON ALLOTMENT
FOR EACH ROW
BEGIN
INSERT INTO ALLOTMENT@RUNNYTOTIFFY VALUES
(:NEW.ROLLNO,:NEW.COLL_CODE,:NEW.BCODE);
END;

@SITE KITTY
CREATE OR REPLACE TRIGGER AVAILABILITY 
AFTER INSERT ON ALLOTMENT
FOR EACH ROW
BEGIN
INSERT INTO ALLOTMENT@KITTYTOTIFFY VALUES
(:NEW.ROLLNO,:NEW.COLL_CODE,:NEW.BCODE);
END;

@SITE TIFFY
CREATE OR REPLACE TRIGGER AVAILABILITY
AFTER INSERT ON ALLOTMENT
FOR EACH ROW
BEGIN
UPDATE COLL_BRANCH SET NOS=NOS-1
WHERE COLL_BRANCH=:NEW.COLL_CODE AND BCODE=:NEW.BCODE;
UPDATE COLL_BRANCH@TIFFYTORUNNY SET NOS=NOS-1
WHERE COLL_BRANCH=:NEW.COLL_CODE AND BCODE=:NEW.BCODE;
UPDATE COLL_BRANCH@TIFFYTOKITTY SET NOS=NOS-1
WHERE COLL_BRANCH=:NEW.COLL_CODE AND BCODE=:NEW.BCODE;
END;

COMMIT;

@SITE TIFFY
INSERT INTO ALLOTMENT VALUES(12345, 1, 'CSE');
COMMIT;
SELECT * FROM COLL_BRANCH;
SELECT * FROM ALLOTMENT;

@SITE RUNNY
INSERT INTO ALLOTMENT VALUES(12344, 1, 'CSE');
COMMIT;
SELECT * FROM COLL_BRANCH;
SELECT * FROM ALLOTMENT;

@SITE KITTY
INSERT INTO ALLOTMENT VALUES(12355, 1, 'CSE');
COMMIT;
SELECT * FROM COLL_BRANCH;
SELECT * FROM ALLOTMENT;

@SITE TIFFY
INSERT INTO ALLOTMENT VALUES(12356, 1, 'CSE');
COMMIT;
SELECT * FROM COLL_BRANCH;
SELECT * FROM ALLOTMENT;

